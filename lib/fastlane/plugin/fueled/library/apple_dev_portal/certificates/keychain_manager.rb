# frozen_string_literal: true

require 'open3'
require 'fastlane_core/ui/ui'
require 'fastlane_core/helper'

module Fastlane
  module Helper
    module AppleDevPortal
      module Certificates
        module KeychainManager
          module_function

          KEYCHAIN_NAME = 'fueled.keychain-db'
          KEYCHAIN_PATH = File.expand_path("~/Library/Keychains/#{KEYCHAIN_NAME}")
          PASSWORD = 'fueled-autogenerated'

          # Ensure the custom keychain exists and is accessible
          def ensure_accessible
            return unless FastlaneCore::Helper.mac?

            ensure_exists
            add_to_search_list
            unlock
          end

          def add_to_search_list
            return unless FastlaneCore::Helper.mac?
            return unless File.exist?(KEYCHAIN_PATH)

            current_list, _, _ = Open3.capture3('security', 'list-keychains', '-d', 'user')
            current_keychains = current_list.strip.split("\n").map { |line| line.strip.gsub(/^"|"$/, '') }
            
            keychain_in_list = current_keychains.any? { |path| path == KEYCHAIN_PATH || path == File.expand_path(KEYCHAIN_PATH) }
            
            unless keychain_in_list
              new_list = current_keychains + [KEYCHAIN_PATH]
              _, err, status = Open3.capture3(
                'security', 'list-keychains', '-d', 'user', '-s', *new_list
              )

              unless status.success?
                UI.important("Warning: Could not add keychain to search list: #{err}")
              end
            end
          end

          def ensure_exists
            return unless FastlaneCore::Helper.mac?
            return if File.exist?(KEYCHAIN_PATH)

            UI.message("Creating custom keychain for certificate storage...")
            
            _, err, status = Open3.capture3(
              'security', 'create-keychain',
              '-p', PASSWORD,
              KEYCHAIN_PATH
            )

            unless status.success?
              UI.user_error!("Failed to create keychain: #{err}")
            end

            _, err, status = Open3.capture3(
              'security', 'set-keychain-settings',
              '-u',
              KEYCHAIN_PATH
            )

            unless status.success?
              UI.important("Warning: Could not set keychain settings: #{err}")
            end


            UI.success("âœ“ Custom keychain created")
          end

          # Unlock the keychain
          def unlock
            return unless FastlaneCore::Helper.mac?
            return unless File.exist?(KEYCHAIN_PATH)

            _, err, status = Open3.capture3(
              'security', 'unlock-keychain',
              '-p', PASSWORD,
              KEYCHAIN_PATH
            )

            unless status.success?
              UI.important("Warning: Could not unlock keychain: #{err}")
            end
          end

          # Get the keychain path
          def keychain_path
            KEYCHAIN_PATH
          end

          # Get the keychain name (for use with security commands)
          def keychain_name
            KEYCHAIN_NAME
          end

          # Get the keychain password
          def password
            PASSWORD
          end
        end
      end
    end
  end
end

